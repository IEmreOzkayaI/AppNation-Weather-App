# AppNation Gateway (`appnation-gw`)

This project is the API Gateway service, acting as the main entry point for the AppNation microservice architecture. It routes incoming requests to the appropriate backend services and performs critical functions such as authentication, rate limiting, and resilience.

## Table of Contents

- [Overview](#overview)
- [Key Features](#key-features)
- [Technologies Used](#technologies-used)
- [Configuration](#configuration)
  - [Main Configuration File](#main-configuration-file)
  - [Environment Variables](#environment-variables)
- [Prerequisites (for Standalone Development)](#prerequisites-for-standalone-development)
- [Running the Service](#running-the-service)
  - [With Docker Compose (Recommended)](#with-docker-compose-recommended)
  - [Standalone](#standalone)
- [Core Components](#core-components)
  - [Filters](#filters)
- [API Routing](#api-routing)

## Overview

`appnation-gw` is an API Gateway developed using Spring Cloud Gateway. It provides a single access point to other services in the microservice architecture (Identity Service, Weather Service, etc.). It implements gateway patterns such as security, routing, load balancing (can be added in the future), rate limiting, and circuit breaking.

## Key Features

-   **JWT-Based Authentication:** Validates JWTs in incoming requests and performs authorization (<mcsymbol name="AdminFilter" filename="AdminFilter.java" path="appnation-gw/src/main/java/appNation/filters/AdminFilter.java" startline="15" type="class"></mcsymbol>, <mcsymbol name="UserFilter" filename="UserFilter.java" path="appnation-gw/src/main/java/appNation/filters/UserFilter.java" startline="15" type="class"></mcsymbol>).
-   **Redis-Based Rate Limiting:** Limits the number of requests a client can make within a specific time window.
-   **Circuit Breaker:** Provides resilience against failures in dependent services using Resilience4j.
-   **Dynamic Routing:** Routes requests to the appropriate services based on rules defined in <mcfile name="application.yml" path="appnation-gw/src/main/resources/application.yml"></mcfile>.

## Technologies Used

-   Java (JDK 17)
-   Spring Boot
-   Spring Cloud Gateway
-   Spring Security
-   Resilience4j (Circuit Breaker)
-   Redis (for Rate Limiting)
-   Maven (Dependency Management and Project Build)

## Configuration

### Main Configuration File

The service's main configuration, including routing rules, filters, and other Spring Boot settings, is located in <mcfile name="application.yml" path="appnation-gw/src/main/resources/application.yml"></mcfile>.

### Environment Variables

The service requires certain environment variables to run. These variables are defined in the <mcfile name=".env" path="appnation-gw/.env"></mcfile> file, which can be set via the project's root <mcfile name="docker-compose.yml" path="docker-compose.yml"></mcfile> or directly as system environment variables if run standalone.

**Important Environment Variables (`appnation-gw/.env`):**

-   `REDIS_HOST`: Address of the Redis server.
-   `REDIS_PORT`: Port of the Redis server.
-   `REDIS_PASSWORD`: Password for the Redis server.
-   `PORT`: Port on which the Gateway service will run.
-   `REDIS_DATABASE_APPNATION`: Redis database number to use.
-   `RATE_LIMITER_BURST_CAPACITY`: Maximum number of requests the rate limiter can accept instantaneously.
-   `RATE_LIMITER_REPLENISH_RATE`: Number of tokens the rate limiter will replenish per second.
-   `HTTP_BIN_BASE_URL`: Base URL for the HttpBin service (usually for testing).
-   `APPNATION_WEATHER_BASE_URL`: Base URL for the Weather Service.
-   `APPNATION_IDENTITY_BASE_URL`: Base URL for the Identity Service.
-   `JWT_PUBLIC_KEY`: Public key used to verify JWTs generated by the Identity Service.
-   `APPNATION_GATEWAY_LOG_LEVEL`: Log level for the Gateway application (e.g., ERROR, INFO, DEBUG).

## Prerequisites (for Standalone Development)

-   Java Development Kit (JDK) 17 or higher
-   Apache Maven
-   A running Redis instance
-   Accessible Identity and Weather services (or their mocks)

## Running the Service

### With Docker Compose (Recommended)

The Gateway service can be easily started along with the entire AppNation project using Docker Compose. In the project's root directory (<mcfolder name="appNation" path="/Users/25200282/Desktop/appNation"></mcfolder>), run the following command:

```bash
docker-compose up --build -d appnation-gw
```

Or to start all services:

```bash
docker-compose up --build -d
```

### Standalone

To run the Gateway service standalone (outside of Docker):

1.  Ensure the necessary environment variables are set.
2.  In the project directory (`appnation-gw`), run the following Maven command:
    ```bash
    mvn spring-boot:run
    ```
    Alternatively, you can first build the project and then run the JAR file:
    ```bash
    mvn clean package
    java -jar target/appnation-gw-0.0.1-SNAPSHOT.jar
    ```
    *(Note: The JAR file name may vary based on your project's `pom.xml` configuration.)*

## Core Components

### Filters

The Gateway uses filters to apply various operations to incoming requests and outgoing responses. Key custom filters include:

-   <mcsymbol name="AdminFilter" filename="AdminFilter.java" path="appnation-gw/src/main/java/appNation/filters/AdminFilter.java" startline="15" type="class"></mcsymbol>: Performs JWT validation and admin role check for requests to `/identity/v1/admin/**` and `/weather/v1/admin/**` paths.
-   <mcsymbol name="UserFilter" filename="UserFilter.java" path="appnation-gw/src/main/java/appNation/filters/UserFilter.java" startline="15" type="class"></mcsymbol>: Performs JWT validation and user role check for requests to `/identity/v1/user/**` and `/weather/v1/user/**` paths.

These filters are located under the `appNation.filters` package.

## API Routing

The Gateway routes requests to the appropriate microservices based on rules defined in the `spring.cloud.gateway.routes` section of <mcfile name="application.yml" path="appnation-gw/src/main/resources/application.yml"></mcfile>.

Below are the main routing rules defined:

-   **Identity Service - Admin API**
    -   **ID:** `identity-service-admin`
    -   **URI:** `lb://appnation-identity-service` (Identity Service via Load Balancer)
    -   **Path Predicate:** `/identity/v1/admin/**`
    -   **Filters:**
        -   `StripPrefix=2`: Removes `/identity/v1` from the request path.
        -   `AdminFilter`: Applies admin authorization for this path.
        -   `Retry`: Retry mechanism in case of errors.
        -   `CircuitBreaker`: Resilience4j circuit breaker.

-   **Identity Service - User API**
    -   **ID:** `identity-service-user`
    -   **URI:** `lb://appnation-identity-service`
    -   **Path Predicate:** `/identity/v1/user/**`
    -   **Filters:**
        -   `StripPrefix=2`: Removes `/identity/v1` from the request path.
        -   `UserFilter`: Applies user authorization for this path.
        -   `Retry`: Retry mechanism.
        -   `CircuitBreaker`: Circuit breaker.

-   **Identity Service - General Authentication API**
    -   **ID:** `identity-service-auth`
    -   **URI:** `lb://appnation-identity-service`
    -   **Path Predicate:** `/identity/v1/auth/**`
    -   **Filters:**
        -   `StripPrefix=2`: Removes `/identity/v1` from the request path.
        -   `Retry`: Retry mechanism.
        -   `CircuitBreaker`: Circuit breaker.
        -   `RequestRateLimiter`: Applies request rate limiting.

-   **Weather Service - Admin API**
    -   **ID:** `weather-service-admin`
    -   **URI:** `lb://appnation-weather-service` (Weather Service via Load Balancer)
    -   **Path Predicate:** `/weather/v1/admin/**`
    -   **Filters:**
        -   `StripPrefix=2`: Removes `/weather/v1` from the request path.
        -   `AdminFilter`: Applies admin authorization for this path.
        -   `Retry`: Retry mechanism.
        -   `CircuitBreaker`: Circuit breaker.

-   **Weather Service - User API**
    -   **ID:** `weather-service-user`
    -   **URI:** `lb://appnation-weather-service`
    -   **Path Predicate:** `/weather/v1/user/**`
    -   **Filters:**
        -   `StripPrefix=2`: Removes `/weather/v1` from the request path.
        -   `UserFilter`: Applies user authorization for this path.
        -   `Retry`: Retry mechanism.
        -   `CircuitBreaker`: Circuit breaker.

-   **HttpBin (For Testing)**
    -   **ID:** `httpbin_route`
    -   **URI:** `${http_bin_base_url}` (Taken from environment variable, e.g., `https://httpbin.org`)
    -   **Path Predicate:** `/httpbin/**`
    -   **Filters:**
        -   `StripPrefix=1`: Removes `/httpbin` from the request path.
